

# CVE-2020-27986 | SonarQube <= 8.4.2.36762 存在弱口令、API未授权



## 0x00 漏洞说明

在SonarQube <= 8.4.2.36762 版本中，平台默认配置将可造成敏感信息泄露的API接口对外公开，并且未进行身份认证。且平台默认密码为弱口令，造成托管代码泄露。



## 0x01 影响版本

- SonarQube <= 8.4.2.36762



## 0x02 漏洞成因

1. 由于平台管理者未对默认的权限配置文件进行修改，导致API对外开放访问，且未对API使用进行有效的身份认证，导致执行高危操作，最终泄露平台托管的全部源代码、用户等敏感信息

## 0x03 详细分析

经过测试，以下API列表均可以在默认配置的情况下进行访问


```
#共57条
/api/ce/component
/api/ce/task
/api/ce/task_types
/api/components/app
/api/components/search
/api/components/search_projects
/api/components/suggestions
/api/components/tree
/api/duplications/show
/api/emails/send
/api/issues/changelog
/api/issues/search
/api/measures/component
/api/measures/component_tree
/api/measures/search
/api/measures/search_history
/api/metrics/search
/api/metrics/search
/api/metrics/types
/api/navigation/component
/api/navigation/global
/api/navigation/settings
/api/organizations/search
/api/organizations/search_members
/api/project_badges/measure
/api/project_badges/quality_gate
/api/project_branches/list
/api/project_tags/search
/api/project_tags/search
/api/qualitygates/list
/api/qualitygates/show?id=1
/api/qualityprofiles/importers
/api/qualityprofiles/inheritance
/api/qualityprofiles/search
/api/qualityprofiles/show
/api/rules/list
/api/rules/repositories
/api/rules/search
/api/rules/show
/api/rules/tags
/api/rules/update
/api/server/version
/api/settings/list_definitions
/api/settings/values
/api/sources/index
/api/sources/raw
/api/sources/show
/api/system/db_migration_status
/api/system/migrate_db
/api/system/status
/api/system/upgrades
/api/users/current
/api/users/identity_providers
/api/users/search
/api/webservices/list
/api/webservices/response_example
/batch/project
```

***其中有几个值得注意的API接口:*** 


|PATH|Description|Response Contents|Request Parameters 1|Request Parameters 2|Request Parameters 3|Availability after fix|
|----|----|----|----|----|:---|:--:|
|/api/server/version|返回应用的版本号|应用版本号||||√|
| /api/settings/values |列出一些设定的值|可能会返回一些敏感信息，但是几率不大||||×|
| /api/users/search |列出活跃的用户|泄露几乎所有的用户列表，可以用于密码爆破||||×|
| /api/webservices/list |列出网络服务|返回一些api目录和api的详细信息||||×|
| /api/components/search_projects |搜索项目|返回敏感信息：organization、Project(ID)、Project(Key)等||||×|
| /api/components/tree |根据所选策略浏览组件|返回大量敏感信息：File(Key)、Project(Key)、Project(ID)等|component：Project(Key)|componentId：Project(ID)||×|
| /api/emails/send |通过发送电子邮件测试电子邮件配置|需要先进行认证，但是认证成功后可以利用配置的邮箱进行钓鱼等横向操作|message：邮件内容|subject：邮件标题|to：目标邮箱|×|
| /api/issues/search |阅读和更新Issues|返回敏感大量信息：issues(key)、File Key(Key)、project(Key)、author(Email)、与其他issues内容信息||||×|
| /api/issues/changelog |显示Issues的变更日志|如果有Issues的变更记录则返回|issue：Issue(key)|||×|
| /api/measures/component_tree |获取具有指定度量的组件或子项|返回大量敏感信息：Project(ID)、File(Key)文件名等|metricKeys：ncloc,complexity,violations|component：Project(Key)|baseComponentId：Project(ID)|×|
| /api/navigation/component |获取有关当前用户的组件导航的信息。|返回少量敏感信息：project(Key)、organization、Project(ID)等|component：Project(Key)|||×|
| /api/rules/list |列出规则，不包括手动规则和状态为 REMOVED 的规则|返回相关API规则信息||||×|
| /api/settings/list_definitions |列出API的设置定义|返回相关API定义内容||||×|
| /batch/project |返回项目存储库|返回指定项目中所有的存储库和文件目录以及其他敏感信息|key：Project(Key)|||×|
| /api/sources/raw |以原始文本形式获取源代码|以原始文本形式获取指定文件的源代码(重点)|key:File(Key)|||×|
| /api/sources/index |获取源代码|获取指定文件的源代码(重点)|key:File(Key)|||×|
| /api/sources/show |以行号/文本对的形式获取源代码|以行号/文本对的形式获取指定文件的源代码(重点)|key:File(Key)|||×|



***以下是一些参数的对应内容:***


| API                             | 上表对应值    | API返回键    | 注释                                                         |
| ------------------------------- | ------------- | ------------ | ------------------------------------------------------------ |
| /api/components/search_projects | organization  | organization | 所属组织名称                                                 |
| /api/components/search_projects | Project(ID)   | id           | 项目的唯一标识ID，并非至单一项目，项目中的每个目录、每个文件都拥有一个 |
| /api/components/search_projects | Project(Key)  | key          | 这里的key一般与name单独计算，name是一些项目名称，key则还有可能是文件目录 |
| /api/components/search_projects | File(Key)     | key          | 后期参数需要的key，其格式为:<项目名>:<文件目录>              |
| /api/components/tree            | File(Key)     | component    | 后期参数需要的key，其格式为:<项目名>:<文件目录>              |
| /api/components/tree            | Project(Key)  | project      | 这里的key一般与name单独计算，name是一些项目名称，key则还有可能是文件目录 |
| /api/components/tree            | Project(ID)   | key          | 项目的唯一标识ID，并非至单一项目，项目中的每个目录、每个文件都拥有一个 |
| /api/issues/search              | issues(key)   | key          | 标识每个issues，每个回复每个问题都有一个                     |
| /api/issues/search              | File (Key)    | component    | 后期参数需要的key，其格式为:<项目名>:<文件目录>              |
| /api/issues/search              | Project(Key)  | project      | 这里的key一般与name单独计算，name是一些项目名称，key则还有可能是文件目录 |
| /api/issues/search              | author(Email) | author       | 发起此issues的用户邮箱，可用于钓鱼                           |
| /api/measures/component_tree    | Project(ID)   | id           | 项目的唯一标识ID，并非至单一项目，项目中的每个目录、每个文件都拥有一个 |
| /api/measures/component_tree    | File(Key)     | key          | 后期参数需要的key，其格式为:<项目名>:<文件目录>，但是该API存在项目名(根目录) |
| /api/navigation/component       | project(Key)  | key          | 项目的唯一标识ID，并非至单一项目，项目中的每个目录、每个文件都拥有一个 |
| /api/navigation/component       | organization  | organization | 所属组织名称                                                 |
| /api/navigation/component       | Project(ID)   | id           | 项目的唯一标识ID，并非至单一项目，项目中的每个目录、每个文件都拥有一个 |




## 0x05 漏洞指纹

fofa:

```
app="sonarQube-代码管理"
```





## 0x04 POC & EXP

! FILENAME POC
```bash
crul http://example.com/api/server/version
```

! FILENAME EXP

```
crul http://example.com/api/settings/values
```





## 0x05 进阶利用思路



***一、验证漏洞***

通过 ***/api/server/version*** 和 ***/api/settings/values*** 判断目标系统版本号与是否存在漏洞



***二、弱口令***

通过 ***/api/users/search*** 获取用户列表，对用户密码进行模糊测试



***三、源代码泄露***

1. 通过 ***/api/components/search_projects*** 获取 ***organization*** 、***Project(ID)***  和 ***Project(Key)*** 等后续需要的信息
2. 通过 ***/api/components/tree*** 或 ***/batch/project***  并代入之前获取的 ***Project(ID)***  和 ***Project(Key)***  参数，获取 ***File(Key)*** ，也就是<项目名>:<文件目录>和其他后续需要的信息
3. 通过 ***/api/sources/raw*** 、 ***/api/sources/index*** 或 ***/api/sources/show*** 并带入之前获取的 ***File(Key)*** 参数，获取目标文件的源代码



***四、可能存在的横向移动***

1. 通过 ***/api/issues/search*** 获取人员联络方式(邮件)
2. 获取权限后通过 ***/api/emails/send*** 对其人员进行钓鱼攻击



## 0x06 扩展链接



[Atw组织攻击分析及cve 2020 27986进阶利用](https://n0b1ta.github.io/ATW%E7%BB%84%E7%BB%87%E6%94%BB%E5%87%BB%E5%88%86%E6%9E%90%E5%8F%8ACVE-2020-27986%E8%BF%9B%E9%98%B6%E5%88%A9%E7%94%A8)

[【安全事件】黑客利用开源代码平台SonarQube漏洞泄露多家单位源码](https://mp.weixin.qq.com/s/LDZQZF-nMCvPFZc6DqRuQw)

[CVE-2020-27986 ](https://nvd.nist.gov/vuln/detail/CVE-2020-27986#match-6091889)

## 0x7 联系方式

作者 : 08174
